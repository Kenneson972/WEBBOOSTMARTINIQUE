---
# WebBoost Martinique - DÃ©ploiement automatique GitHub â†’ 02switch
# Architecture : HTML/CSS/JS + API PHP

deployment:
  tasks:
    # PrÃ©paration environnement
    - export DEPLOYPATH=/home/weboostmartinique/public_html/
    - echo "ğŸš€ DÃ©but dÃ©ploiement WebBoost Martinique..."
    
    # Nettoyage dossier cible (sÃ©curisÃ©)
    - /bin/find $DEPLOYPATH -maxdepth 1 -name "*.html" -delete 2>/dev/null || true
    - /bin/find $DEPLOYPATH -maxdepth 1 -name "*.css" -delete 2>/dev/null || true
    - /bin/find $DEPLOYPATH -maxdepth 1 -name "*.js" -delete 2>/dev/null || true
    - /bin/rm -rf $DEPLOYPATH/assets/ 2>/dev/null || true
    - /bin/rm -rf $DEPLOYPATH/api/ 2>/dev/null || true
    
    # DÃ©ploiement fichiers principaux
    - echo "ğŸ“„ Copie fichiers HTML..."
    - /bin/cp *.html $DEPLOYPATH/
    - /bin/cp .htaccess $DEPLOYPATH/
    - /bin/cp robots.txt $DEPLOYPATH/ 2>/dev/null || true
    - /bin/cp sitemap.xml $DEPLOYPATH/ 2>/dev/null || true
    - /bin/cp favicon.ico $DEPLOYPATH/ 2>/dev/null || true
    
    # DÃ©ploiement assets (structure prÃ©servÃ©e)
    - echo "ğŸ¨ Copie assets (CSS, JS, images)..."
    - /bin/cp -R assets/ $DEPLOYPATH/
    
    # DÃ©ploiement API backend
    - echo "âš™ï¸ Copie API backend..."
    - /bin/cp -R api/ $DEPLOYPATH/
    
    # Variables environnement (sÃ©curisÃ©)
    - /bin/cp .env $DEPLOYPATH/ 2>/dev/null || echo "âš ï¸ Fichier .env non trouvÃ© - normal en dÃ©veloppement"
    
    # Permissions fichiers (sÃ©curitÃ© 02switch)
    - echo "ğŸ” Configuration permissions..."
    - find $DEPLOYPATH -name "*.php" -exec chmod 755 {} \;
    - find $DEPLOYPATH -name "*.html" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.css" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.js" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.png" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.jpg" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.jpeg" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.gif" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.svg" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.ico" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.xml" -exec chmod 644 {} \;
    - find $DEPLOYPATH -name "*.txt" -exec chmod 644 {} \;
    - chmod 644 $DEPLOYPATH/.htaccess 2>/dev/null || true
    - chmod 600 $DEPLOYPATH/.env 2>/dev/null || true
    
    # Nettoyage fichiers dÃ©veloppement
    - echo "ğŸ§¹ Nettoyage fichiers dÃ©veloppement..."
    - /bin/rm -rf $DEPLOYPATH/.git/ 2>/dev/null || true
    - /bin/rm -rf $DEPLOYPATH/node_modules/ 2>/dev/null || true
    - /bin/rm -rf $DEPLOYPATH/.vscode/ 2>/dev/null || true
    - /bin/rm -rf $DEPLOYPATH/.idea/ 2>/dev/null || true
    - /bin/rm -f $DEPLOYPATH/package*.json 2>/dev/null || true
    - /bin/rm -f $DEPLOYPATH/yarn.lock 2>/dev/null || true
    - /bin/rm -f $DEPLOYPATH/*.log 2>/dev/null || true
    - /bin/rm -f $DEPLOYPATH/.cpanel.yml 2>/dev/null || true
    
    # VÃ©rification structure dÃ©ployÃ©e
    - echo "ğŸ” VÃ©rification dÃ©ploiement..."
    - ls -la $DEPLOYPATH/
    - test -f $DEPLOYPATH/index.html && echo "âœ… index.html dÃ©ployÃ©"
    - test -d $DEPLOYPATH/assets/ && echo "âœ… assets dÃ©ployÃ©s"
    - test -d $DEPLOYPATH/api/ && echo "âœ… API dÃ©ployÃ©e"
    - test -f $DEPLOYPATH/.htaccess && echo "âœ… .htaccess configurÃ©"
    
    # Test basique de structure
    - test -f $DEPLOYPATH/assets/css/main.css && echo "âœ… CSS principal prÃ©sent"
    - test -f $DEPLOYPATH/assets/js/chatbot.js && echo "âœ… Chatbot Ã‰lise prÃ©sent"
    - test -f $DEPLOYPATH/api/chat.php && echo "âœ… API chat prÃ©sente"
    
    # Log final
    - echo "ğŸ‰ WebBoost Martinique dÃ©ployÃ© avec succÃ¨s sur 02switch Ã  $(date)"
    - echo "ğŸ“ DÃ©ploiement terminÃ©" >> $DEPLOYPATH/deployment.log
    - echo "ğŸŒ Site disponible : https://weboostmartinique.com"